
import React, { useState, useEffect } from 'react';
import { db } from '../services/mockBackend';
import { generateArtworkDetails } from '../services/geminiService';
import { Artwork, ArtworkStatus, Appointment } from '../types'; 
import { Plus, Trash2, Edit, Sparkles, X, Settings, Heart, Calendar, CheckCircle, Clock, User, FileText, Save, Phone } from 'lucide-react';

const AdminDashboard: React.FC = () => {
  const [activeTab, setActiveTab] = useState<'artworks' | 'appointments'>('artworks');
  const [artworks, setArtworks] = useState<Artwork[]>([]);
  const [appointments, setAppointments] = useState<Appointment[]>([]);
  const [categories, setCategories] = useState<string[]>([]);
  const [stats, setStats] = useState<Record<string, number>>({}); // Artwork favorites stats
  
  // --- Artwork Form State ---
  const [isFormOpen, setIsFormOpen] = useState(false);
  const [isCatManagerOpen, setIsCatManagerOpen] = useState(false);
  const [editingId, setEditingId] = useState<string | null>(null);

  const [title, setTitle] = useState('');
  const [category, setCategory] = useState('');
  const [price, setPrice] = useState('');
  const [specialPrice, setSpecialPrice] = useState(''); 
  const [imageUrl, setImageUrl] = useState(''); 
  const [description, setDescription] = useState('');
  const [tags, setTags] = useState<string[]>([]);
  
  const [aiLoading, setAiLoading] = useState(false);
  const [newCategoryInput, setNewCategoryInput] = useState('');

  // --- Appointment Edit State ---
  const [isAptModalOpen, setIsAptModalOpen] = useState(false);
  const [editingApt, setEditingApt] = useState<Appointment | null>(null);
  const [aptForm, setAptForm] = useState({
      date: '',
      timeSlot: '',
      customerName: '',
      phoneNumber: '',
      artworkTitle: '', 
      notes: '',
      status: 'OPEN' as 'OPEN' | 'PENDING' | 'BOOKED' | 'COMPLETED'
  });

  useEffect(() => {
    loadData();
    loadCategories();
  }, [activeTab]);

  const loadData = async () => {
    try {
        const [data, artworkStats, apts] = await Promise.all([
            db.getArtworks(),
            db.getArtworkStats(),
            db.getAppointments()
        ]);
        setArtworks(data.reverse()); // Newest first
        setStats(artworkStats);
        
        // Filter appointments: show all non-OPEN or OPEN slots that have data (rare)
        const activeApts = apts
            .filter(a => a.status !== 'OPEN') 
            .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
        setAppointments(activeApts);
    } catch (e: any) {
        console.error("Error loading admin data", e);
    }
  };

  const loadCategories = async () => {
    try {
        const cats = await db.getCategories();
        setCategories(cats);
        if (!category && cats.length > 0) {
            const defaultCat = cats.find(c => c !== 'All') || cats[0];
            setCategory(defaultCat);
        }
    } catch (e) {
        console.error("Error loading categories", e);
    }
  };

  // --- Artwork Handlers ---

  const handleEditArtwork = (art: Artwork) => {
    setEditingId(art.id);
    setTitle(art.title);
    setCategory(art.category);
    setPrice(art.price ? art.price.toString() : '');
    setSpecialPrice(art.specialPrice ? art.specialPrice.toString() : '');
    setImageUrl(art.imageUrl);
    setDescription(art.description);
    setTags(art.tags);
    setIsFormOpen(true);
  };

  const handleImageChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onloadend = () => {
        setImageUrl(reader.result as string);
      };
      reader.readAsDataURL(file);
    }
  };

  const handleAiGenerate = async () => {
    if (!title && !category) return;
    setAiLoading(true);
    try {
        const result = await generateArtworkDetails(`${category} tattoo style, ${title}`);
        setDescription(result.description);
        setTags(result.tags);
    } catch (e) {
        alert("AI 生成失敗，請重試。");
    } finally {
        setAiLoading(false);
    }
  };

  const getMysqlDateTime = () => {
    const now = new Date();
    const pad = (n: number) => n.toString().padStart(2, '0');
    return `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
  };

  const handleSubmitArtwork = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!title || !imageUrl) return;

    const newArtwork: Artwork = {
      id: editingId || Date.now().toString(),
      title,
      description: description || 'No description provided.',
      imageUrl: imageUrl, 
      category,
      price: price ? Number(price) : undefined,
      specialPrice: specialPrice ? Number(specialPrice) : undefined,
      status: editingId ? artworks.find(a => a.id === editingId)?.status || ArtworkStatus.AVAILABLE : ArtworkStatus.AVAILABLE,
      createdAt: editingId ? (artworks.find(a => a.id === editingId)?.createdAt || getMysqlDateTime()) : getMysqlDateTime(),
      tags: tags
    };

    try {
        await db.saveArtwork(newArtwork);
        setIsFormOpen(false);
        setEditingId(null);
        resetArtworkForm();
        loadData();
    } catch (error: any) {
        console.error(error);
        alert(`無法儲存作品。\n\n錯誤: ${error.message}`);
    }
  };

  const handleDeleteArtwork = async (id: string) => {
    if (window.confirm('確定要刪除此作品嗎？')) {
      try {
        await db.deleteArtwork(id);
        loadData();
      } catch (error: any) {
        alert(`刪除失敗: ${error.message}`);
      }
    }
  };

  const toggleStatus = async (id: string) => {
    try {
        await db.toggleStatus(id);
        loadData();
    } catch (error: any) {
        alert(`狀態更新失敗: ${error.message}`);
    }
  };

  const handleAddCategory = async () => {
    if (newCategoryInput.trim()) {
      try {
        const updated = await db.addCategory(newCategoryInput.trim());
        setCategories(updated);
        setNewCategoryInput('');
      } catch (error: any) {
        alert(`新增分類失敗: ${error.message}`);
      }
    }
  };

  const handleDeleteCategory = async (cat: string) => {
    if (window.confirm(`確定要刪除分類 "${cat}" 嗎？`)) {
        try {
            const updated = await db.deleteCategory(cat);
            setCategories(updated);
        } catch (error: any) {
            alert(`刪除失敗: ${error.message}`);
        }
    }
  };

  const resetArtworkForm = () => {
    setTitle('');
    setDescription('');
    setPrice('');
    setSpecialPrice('');
    setTags([]);
    setImageUrl('');
    setEditingId(null);
    if (categories.length > 0) {
        const defaultCat = categories.find(c => c !== 'All') || categories[0];
        setCategory(defaultCat);
    }
  };

  // --- Appointment Handlers ---

  const confirmAppointment = async (apt: Appointment) => {
      if (window.confirm(`確認已收到 ${apt.customerName} 的訂金？`)) {
          try {
            const updatedApt: Appointment = { ...apt, status: 'BOOKED' };
            await db.saveAppointment(updatedApt);
            loadData();
          } catch (error: any) {
            alert(`確認失敗: ${error.message}`);
          }
      }
  };

  const cancelAppointment = async (id: string) => {
      if (window.confirm('確定要取消此預約並釋出時段嗎？')) {
          try {
            await db.cancelAppointment(id);
            loadData();
          } catch (error: any) {
            alert(`取消失敗: ${error.message}`);
          }
      }
  };

  const handleEditAppointment = (apt: Appointment) => {
      setEditingApt(apt);
      setAptForm({
          date: apt.date,
          timeSlot: apt.timeSlot,
          customerName: apt.customerName || '',
          phoneNumber: apt.phoneNumber || '',
          artworkTitle: apt.artworkTitle || '',
          notes: apt.notes || '',
          status: apt.status
      });
      setIsAptModalOpen(true);
  };

  const handleSaveAppointment = async (e: React.FormEvent) => {
      e.preventDefault();
      if (!editingApt) return;

      const updatedApt: Appointment = {
          ...editingApt,
          date: aptForm.date,
          timeSlot: aptForm.timeSlot,
          customerName: aptForm.customerName,
          phoneNumber: aptForm.phoneNumber,
          artworkTitle: aptForm.artworkTitle,
          notes: aptForm.notes,
          status: aptForm.status
      };

      try {
        await db.saveAppointment(updatedApt);
        setIsAptModalOpen(false);
        setEditingApt(null);
        loadData();
      } catch (error: any) {
        alert(`儲存失敗: ${error.message}`);
      }
  };

  return (
    <div className="max-w-7xl mx-auto px-4 py-8">
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold text-white">管理後台</h1>
        
        {activeTab === 'artworks' && (
            <div className="flex gap-2">
                <button 
                onClick={() => setIsCatManagerOpen(true)}
                className="bg-gray-800 text-gray-300 px-4 py-2 rounded-lg font-bold flex items-center hover:bg-gray-700 transition-colors"
                >
                <Settings size={20} className="mr-2" /> 管理分類
                </button>
                <button 
                onClick={() => { resetArtworkForm(); setIsFormOpen(true); }}
                className="bg-primary text-black px-4 py-2 rounded-lg font-bold flex items-center hover:bg-yellow-500 transition-colors"
                >
                <Plus size={20} className="mr-2" /> 新增作品
                </button>
            </div>
        )}
      </div>

      {/* Tabs */}
      <div className="flex gap-4 border-b border-gray-700 mb-6">
        <button 
          onClick={() => setActiveTab('artworks')}
          className={`pb-2 px-4 ${activeTab === 'artworks' ? 'text-primary border-b-2 border-primary' : 'text-gray-400'}`}
        >
          作品管理
        </button>
        <button 
           onClick={() => setActiveTab('appointments')}
           className={`pb-2 px-4 ${activeTab === 'appointments' ? 'text-primary border-b-2 border-primary' : 'text-gray-400'}`}
        >
          預約管理 ({appointments.filter(a => a.status === 'PENDING').length} 待審核)
        </button>
      </div>

      {/* --- Artwork List --- */}
      {activeTab === 'artworks' && (
        <div className="bg-card rounded-xl border border-white/5 overflow-hidden">
          <table className="w-full text-left">
            <thead className="bg-dark text-gray-400 text-xs uppercase">
              <tr>
                <th className="px-6 py-4">縮圖</th>
                <th className="px-6 py-4">資訊</th>
                <th className="px-6 py-4">價格</th>
                <th className="px-6 py-4">狀態</th>
                <th className="px-6 py-4 text-right">操作</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-800">
              {artworks.map(art => (
                <tr key={art.id} className="hover:bg-white/5 transition-colors">
                  <td className="px-6 py-4">
                    <img src={art.imageUrl} alt="" className="w-12 h-12 rounded object-cover" />
                  </td>
                  <td className="px-6 py-4">
                    <p className="font-bold text-white">{art.title}</p>
                    <p className="text-xs text-gray-500 mb-1">{art.category}</p>
                    <div className="flex items-center gap-1 text-pink-400 text-xs font-medium">
                        <Heart size={12} className="fill-current"/> 
                        {stats[art.id] || 0} 收藏
                    </div>
                  </td>
                  <td className="px-6 py-4">
                     {art.specialPrice ? (
                         <div className="flex flex-col">
                             <span className="text-red-400 font-bold">${art.specialPrice}</span>
                             <span className="text-gray-600 text-xs line-through">${art.price}</span>
                         </div>
                     ) : (
                        <span className="text-gray-300">${art.price}</span>
                     )}
                  </td>
                  <td className="px-6 py-4">
                    <button 
                      onClick={() => toggleStatus(art.id)}
                      className={`px-3 py-1 rounded-full text-xs font-bold ${art.status === ArtworkStatus.AVAILABLE ? 'bg-green-900 text-green-200' : 'bg-red-900 text-red-200'}`}
                    >
                      {art.status === ArtworkStatus.AVAILABLE ? '未認領' : '已認領'}
                    </button>
                  </td>
                  <td className="px-6 py-4 text-right space-x-2">
                    <button onClick={() => handleEditArtwork(art)} className="text-gray-400 hover:text-white inline-block p-1">
                      <Edit size={18} />
                    </button>
                    <button onClick={() => handleDeleteArtwork(art.id)} className="text-gray-500 hover:text-red-400 inline-block p-1">
                      <Trash2 size={18} />
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {/* --- Appointment List --- */}
      {activeTab === 'appointments' && (
        <div className="bg-card rounded-xl border border-white/5 overflow-hidden">
             {appointments.length === 0 ? (
                 <div className="text-center py-20 text-gray-500">
                     目前沒有預約資料。
                 </div>
             ) : (
                <table className="w-full text-left">
                    <thead className="bg-dark text-gray-400 text-xs uppercase">
                    <tr>
                        <th className="px-6 py-4">日期與時間</th>
                        <th className="px-6 py-4">顧客資訊</th>
                        <th className="px-6 py-4">作品/備註</th>
                        <th className="px-6 py-4">狀態</th>
                        <th className="px-6 py-4 text-right">操作</th>
                    </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-800">
                    {appointments.map(apt => (
                        <tr key={apt.id} className="hover:bg-white/5 transition-colors">
                            <td className="px-6 py-4">
                                <div className="flex items-center gap-2">
                                    <Calendar size={16} className="text-primary"/>
                                    <span className="text-white font-bold">{apt.date}</span>
                                    <span className="text-gray-400 text-sm">@ {apt.timeSlot}</span>
                                </div>
                            </td>
                            <td className="px-6 py-4">
                                <p className="font-bold text-white">{apt.customerName}</p>
                                {apt.phoneNumber && (
                                    <p className="text-xs text-primary flex items-center gap-1 mt-1">
                                        <Phone size={10}/> {apt.phoneNumber}
                                    </p>
                                )}
                            </td>
                            <td className="px-6 py-4">
                                {apt.artworkTitle ? (
                                    <div className="flex items-center gap-2">
                                        {apt.artworkImage && (
                                            <img src={apt.artworkImage} className="w-8 h-8 rounded object-cover border border-white/10" alt="art"/>
                                        )}
                                        <div>
                                            <p className="text-white text-sm">{apt.artworkTitle}</p>
                                        </div>
                                    </div>
                                ) : (
                                    <p className="text-gray-500 text-sm italic">{apt.notes || '無備註'}</p>
                                )}
                            </td>
                            <td className="px-6 py-4">
                                {apt.status === 'PENDING' && (
                                    <span className="bg-yellow-900/30 text-yellow-400 border border-yellow-900/50 px-2 py-1 rounded text-xs font-bold flex items-center w-fit gap-1">
                                        <Clock size={12}/> 待審核
                                    </span>
                                )}
                                {apt.status === 'BOOKED' && (
                                    <span className="bg-green-900/30 text-green-400 border border-green-900/50 px-2 py-1 rounded text-xs font-bold flex items-center w-fit gap-1">
                                        <CheckCircle size={12}/> 已確認
                                    </span>
                                )}
                                {apt.status === 'COMPLETED' && (
                                    <span className="bg-gray-700 text-gray-400 px-2 py-1 rounded text-xs font-bold">已完成</span>
                                )}
                            </td>
                            <td className="px-6 py-4 text-right space-x-2">
                                {apt.status === 'PENDING' && (
                                    <button 
                                        onClick={() => confirmAppointment(apt)}
                                        className="bg-primary text-black text-xs font-bold px-3 py-1.5 rounded hover:bg-yellow-500 transition-colors"
                                    >
                                        確認訂金
                                    </button>
                                )}
                                <button
                                    onClick={() => handleEditAppointment(apt)}
                                    className="bg-gray-700 hover:bg-white hover:text-black text-gray-300 text-xs font-bold px-3 py-1.5 rounded transition-colors"
                                >
                                    <Edit size={14}/>
                                </button>
                                <button 
                                    onClick={() => cancelAppointment(apt.id)}
                                    className="text-red-400 hover:text-red-300 hover:bg-red-900/20 px-3 py-1.5 rounded text-xs font-bold border border-red-900/30"
                                >
                                    取消
                                </button>
                            </td>
                        </tr>
                    ))}
                    </tbody>
                </table>
             )}
        </div>
      )}

      {/* --- Upload Modal --- */}
      {isFormOpen && (
        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
          <div className="bg-card w-full max-w-2xl rounded-2xl shadow-2xl border border-white/10 max-h-[90vh] overflow-y-auto">
            <div className="p-6 border-b border-white/10 flex justify-between items-center">
              <h2 className="text-xl font-bold text-white">{editingId ? '編輯作品' : '上傳新作品'}</h2>
              <button onClick={() => setIsFormOpen(false)} className="text-gray-400 hover:text-white"><X /></button>
            </div>
            
            <form onSubmit={handleSubmitArtwork} className="p-6 space-y-6">
              
              {/* Image Input */}
              <div className="border-2 border-dashed border-gray-700 rounded-xl p-8 text-center hover:border-primary transition-colors cursor-pointer relative">
                <input 
                  type="file" 
                  accept="image/*"
                  onChange={handleImageChange}
                  className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                  required={!imageUrl}
                />
                {imageUrl ? (
                  <img src={imageUrl} alt="Preview" className="mx-auto h-48 object-contain" />
                ) : (
                  <div className="text-gray-500">
                    <p>點擊上傳圖片</p>
                  </div>
                )}
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm text-gray-400 mb-1">作品名稱</label>
                  <input 
                    type="text" 
                    value={title} 
                    onChange={e => setTitle(e.target.value)}
                    className="w-full bg-dark border border-gray-700 rounded p-2 text-white"
                    required
                  />
                </div>
                <div>
                  <label className="block text-sm text-gray-400 mb-1">分類</label>
                  <select 
                    value={category} 
                    onChange={e => setCategory(e.target.value)}
                    className="w-full bg-dark border border-gray-700 rounded p-2 text-white"
                  >
                    {categories.filter(c => c !== 'All').map(c => (
                      <option key={c} value={c}>{c}</option>
                    ))}
                  </select>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm text-gray-400 mb-1">原價</label>
                  <input 
                    type="number" 
                    value={price} 
                    onChange={e => setPrice(e.target.value)}
                    className="w-full bg-dark border border-gray-700 rounded p-2 text-white"
                    placeholder="3000"
                  />
                </div>
                <div>
                  <label className="block text-sm text-gray-400 mb-1">特價 (選填)</label>
                  <input 
                    type="number" 
                    value={specialPrice} 
                    onChange={e => setSpecialPrice(e.target.value)}
                    className="w-full bg-dark border border-gray-700 rounded p-2 text-white"
                    placeholder="2500"
                  />
                </div>
              </div>

              {/* AI Section */}
              <div className="bg-dark/50 p-4 rounded-xl border border-white/5">
                <div className="flex justify-between items-center mb-2">
                  <label className="text-sm font-bold text-gray-300 flex items-center gap-2">
                    <Sparkles size={14} className="text-primary" /> AI 描述生成
                  </label>
                  <button 
                    type="button" 
                    onClick={handleAiGenerate}
                    disabled={!title || aiLoading}
                    className="text-xs text-primary hover:underline disabled:opacity-50"
                  >
                    {aiLoading ? '生成中...' : '自動生成'}
                  </button>
                </div>
                <textarea 
                  value={description}
                  onChange={e => setDescription(e.target.value)}
                  className="w-full bg-black/20 border border-gray-700 rounded p-2 text-sm text-gray-300 h-24"
                  placeholder="輸入標題後點擊自動生成，或手動輸入..."
                />
                <div className="flex flex-wrap gap-2 mt-2">
                  {tags.map(tag => (
                    <span key={tag} className="text-xs bg-gray-800 text-gray-400 px-2 py-1 rounded">#{tag}</span>
                  ))}
                </div>
              </div>

              <button 
                type="submit" 
                className="w-full bg-primary text-black font-bold py-3 rounded-lg hover:bg-yellow-500"
              >
                儲存作品
              </button>
            </form>
          </div>
        </div>
      )}

      {/* --- Appointment Edit Modal --- */}
      {isAptModalOpen && (
        <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4">
            <div className="bg-card w-full max-w-md rounded-2xl shadow-2xl border border-white/10">
                <div className="p-5 border-b border-white/10 flex justify-between items-center bg-dark/50">
                    <h2 className="text-lg font-bold text-white flex items-center gap-2">
                        <Edit size={18} className="text-primary"/> 編輯預約
                    </h2>
                    <button onClick={() => setIsAptModalOpen(false)} className="text-gray-400 hover:text-white"><X size={20}/></button>
                </div>
                <form onSubmit={handleSaveAppointment} className="p-6 space-y-4">
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">日期</label>
                            <input 
                                type="date" 
                                value={aptForm.date} 
                                onChange={e => setAptForm({...aptForm, date: e.target.value})}
                                className="w-full bg-dark border border-gray-700 rounded p-2 text-white focus:border-primary focus:outline-none"
                                required
                            />
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">時間</label>
                            <input 
                                type="time" 
                                value={aptForm.timeSlot} 
                                onChange={e => setAptForm({...aptForm, timeSlot: e.target.value})}
                                className="w-full bg-dark border border-gray-700 rounded p-2 text-white focus:border-primary focus:outline-none"
                                required
                            />
                        </div>
                    </div>

                    <div>
                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">狀態</label>
                        <select 
                            value={aptForm.status} 
                            onChange={e => setAptForm({...aptForm, status: e.target.value as any})}
                            className="w-full bg-dark border border-gray-700 rounded p-2 text-white focus:border-primary focus:outline-none"
                        >
                            <option value="PENDING">PENDING (未付款/待審核)</option>
                            <option value="BOOKED">BOOKED (已確認)</option>
                            <option value="COMPLETED">COMPLETED (已完成)</option>
                        </select>
                    </div>

                    <div>
                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1 flex items-center gap-1"><User size={12}/> 顧客姓名</label>
                        <input 
                            type="text" 
                            value={aptForm.customerName} 
                            onChange={e => setAptForm({...aptForm, customerName: e.target.value})}
                            className="w-full bg-dark border border-gray-700 rounded p-2 text-white focus:border-primary focus:outline-none"
                        />
                    </div>

                    <div>
                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1 flex items-center gap-1"><Phone size={12}/> 手機號碼</label>
                        <input 
                            type="tel" 
                            value={aptForm.phoneNumber} 
                            onChange={e => setAptForm({...aptForm, phoneNumber: e.target.value})}
                            className="w-full bg-dark border border-gray-700 rounded p-2 text-white focus:border-primary focus:outline-none"
                        />
                    </div>

                    <div>
                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1 flex items-center gap-1"><FileText size={12}/> 作品 / 資訊</label>
                        <input 
                            type="text" 
                            value={aptForm.artworkTitle} 
                            onChange={e => setAptForm({...aptForm, artworkTitle: e.target.value})}
                            placeholder="作品名稱或描述"
                            className="w-full bg-dark border border-gray-700 rounded p-2 text-white focus:border-primary focus:outline-none"
                        />
                    </div>

                    <div>
                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">備註</label>
                        <textarea 
                            value={aptForm.notes} 
                            onChange={e => setAptForm({...aptForm, notes: e.target.value})}
                            className="w-full bg-dark border border-gray-700 rounded p-2 text-white h-16 text-sm focus:border-primary focus:outline-none resize-none"
                        />
                    </div>

                    <div className="flex justify-end pt-2">
                         <button 
                            type="submit"
                            className="bg-primary text-black font-bold px-6 py-2 rounded-lg hover:bg-yellow-500 flex items-center gap-2"
                        >
                            <Save size={18}/> 儲存變更
                        </button>
                    </div>
                </form>
            </div>
        </div>
      )}

      {/* --- Category Manager Modal (Simplified) --- */}
      {isCatManagerOpen && (
          <div className="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-4">
              <div className="bg-card w-full max-w-sm rounded-xl p-6 border border-white/10">
                  <h3 className="text-lg font-bold text-white mb-4">管理分類</h3>
                  <ul className="space-y-2 mb-4 max-h-40 overflow-y-auto">
                      {categories.map(cat => (
                          <li key={cat} className="flex justify-between items-center text-sm bg-white/5 p-2 rounded">
                              {cat}
                              {cat !== 'All' && (
                                  <button onClick={() => handleDeleteCategory(cat)} className="text-red-400 hover:text-white"><X size={14}/></button>
                              )}
                          </li>
                      ))}
                  </ul>
                  <div className="flex gap-2">
                      <input 
                        className="flex-1 bg-dark border border-gray-700 rounded px-2 text-sm text-white" 
                        placeholder="新分類名稱"
                        value={newCategoryInput}
                        onChange={e => setNewCategoryInput(e.target.value)}
                      />
                      <button onClick={handleAddCategory} className="bg-primary text-black px-3 rounded font-bold text-sm">新增</button>
                  </div>
                  <button onClick={() => setIsCatManagerOpen(false)} className="w-full mt-4 text-gray-400 text-sm hover:text-white">關閉</button>
              </div>
          </div>
      )}
    </div>
  );
};

export default AdminDashboard;
